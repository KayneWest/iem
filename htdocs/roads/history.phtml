<?php 
include("../../config/settings.inc.php");
include("$rootpath/include/database.inc.php");
include("$rootpath/include/forms.php"); 
$dbconn = iemdb('postgis');

$month = isset($_GET["month"]) ? intval($_GET["month"]) : date("m");
$season = isset($_GET["season"]) ? intval($_GET["season"]) : date("Y");
$segid = isset($_GET["segid"]) ? intval($_GET["segid"]) : "";
$valid = isset($_GET["valid"]) ? substr($_GET["valid"],0,16) : "";

$THISPAGE = "roads-history";
$TITLE = "Historical Iowa Winter Road Conditions";
include("$rootpath/include/header.php"); 
?>

<h3 class="heading">Historical Road Conditions</h3>

<form method="GET" action="history.phtml">
<table cellpadding="3" border="1" cellspacing="0">
<tr>
 <td>Select Road Segment:</td>
 <td>Select Year</td>
 <td>Select Month</td>
 <td></td>
</tr>

<tr>
 <td><?php echo segmentSelect($dbconn, $segid); ?></td>
 <td><?php echo yearSelect2(2006, $season, "season"); ?></td>
 <td><?php echo monthSelect($month); ?></td>
 <td><input type="submit" value="View History"></td>
</tr>
</table>
</form>

<?php 
if (isset($_GET["month"]) && isset($_GET["segid"]) )
{
  echo "<p>Here is a listing of historical road conditions for the segment you 
   selected.  Click on the time of the report to get a listing of all road 
   conditions for that time.";
  echo "<br /><table border=1 cellpadding=2 cellspacing=0><tr><th>Date:</th><th>Report Time:</th><th>Road Segment</th><th>Condition</th></tr>";

   $rs = pg_prepare($dbconn, "SELECT", "SELECT c.label, l.valid, b.major, b.minor from roads_base b, roads_${season}_log l, roads_conditions c WHERE l.segid = $1 and extract(month from l.valid) = $2 and l.cond_code = c.code and b.segid = l.segid ORDER by valid ASC");
  $rs = pg_execute($dbconn, "SELECT", Array($segid, $month));

  for ($i=0; $row = @pg_fetch_array($rs, $i); $i++)
  {
    $ts = strtotime(substr($row["valid"],0,16));
    echo "<tr><td>". strftime('%d %b %Y', $ts) ."</td><td><a href=\"history.phtml?valid=". strftime('%Y-%m-%d%%20%H:%M', $ts) ."\">". strftime('%I:%M %p', $ts) ."</a></td><td>". $row["major"] ." -- ". $row["minor"] ."</td><td>". $row["label"] ."</td></tr>";
  }
  echo "</table>\n";
}
else if ( isset($_GET["valid"]) )
{
  echo "<p>Here is a listing of historical road conditions for a particular
   time for all roads monitored in Iowa.  Click on the segment name to get 
   a listing of historical conditions for that segment.";
  $ts = strtotime(substr($valid,0,16));
  $gisurl = "http://mesonet.agron.iastate.edu/archive/data/". gmdate('Y/m/d/', $ts) ."/GIS/iaroad_cond_". gmdate('YmdHi', $ts) .".zip";
  echo "<p>You can download a <a href=\"$gisurl\">gis shapefile</a> for this reporting time.";
  echo "<br /><table border=1 cellpadding=2 cellspacing=0><tr><th>Date:</th><th>Report Time:</th><th>Road Segment</th><th>Condition</th></tr>";
    $rs = pg_prepare($dbconn, "SELECT", "SELECT c.label, l.valid, b.major, b.minor, b.segid from roads_base b, roads_${season}_log l, roads_conditions c WHERE l.valid = $1 and l.cond_code = c.code and b.segid = l.segid ORDER by major ASC");
  $rs = pg_execute($dbconn, "SELECT", Array($valid));

  for ($i=0; $row = @pg_fetch_array($rs, $i); $i++)
  {
    $ts = strtotime(substr($row["valid"],0,16));
    echo "<tr><td>". strftime('%d %b %Y', $ts) ."</td><td>". strftime('%I:%M %p', $ts) ."</td><td><a href=\"history.phtml?segid=". $row["segid"] ."&month=". strftime('%m', $ts) ."\">". $row["major"] ." -- ". $row["minor"] ."</a></td><td>". $row["label"] ."</td></tr>";
  }
  echo "</table>\n";
}
else
{ ?>
<p>The Iowa Environmental Mesonet archives the road condition reports as 
generated by the Iowa State Patrol.  From this page, you can generate a 
listing of road conditions per road segment for a particular month or a listing
of all road conditions for a particular time.  Currently, our archive is basically complete back to 14 Feb 2006.

<p>You can find an archive of the raw text reports by navigating the IEM's 
archive here:
<code><a href="http://mesonet.agron.iastate.edu/archive/data/2005/01/30/text/">http://mesonet.agron.iastate.edu/archive/data/2005/01/30/text/</a></code>
<br />look for the .STOIA files.  All timestamps are in Greenwhich Mean Time (GMT or UTC), which is 6 hours ahead of us in the winter.  The directory structure of the site is ordered by year, month, and then day.  The example URL is for 30 Jan 2005.

<p><br />and an archive of the GIS shapefiles per report here:
<br /><code><a href="http://mesonet.agron.iastate.edu/archive/data/2005/01/30/GIS/">http://mesonet.agron.iastate.edu/archive/data/2005/01/30/GIS/</a></code>
<br />look for the iaroads_* files.  Again, timestamps are in GMT.

<?php } ?>

<?php include("$rootpath/include/footer.php"); ?>
