<?php
include("../../../../config/settings.inc.php");
include("$rootpath/include/database.inc.php");
include("$rootpath/include/vtec.php");
include("$rootpath/include/wfoLocs.php");
include("$rootpath/include/forms.php");
include("$rootpath/include/lsrs.php");
include("$rootpath/include/google_keys.php");
include('lib.php');
putenv("TZ=GMT");
$connect = iemdb("postgis");
pg_exec($connect, "SET TIME ZONE 'GMT'");


function determine_time_base($t)
{
  /* Round to the nearest 5 minute! */
  $year = date("Y", $t);
  $month = date("m", $t);
  $day = date("d", $t);
  $hour = date("H", $t);
  $m = intval(date("i", $t) / 5) * 5;
  return mktime($hour, $m, 0, $month, $day, $year);
}

/* Get some stuff from our request */
$year = isset($_GET["year"]) ? intval($_GET["year"]) : 2006;
$wfo = isset($_GET["wfo"]) ? substr($_GET["wfo"],0,3) : "MPX";
$eventid = isset($_GET["eventid"]) ? intval($_GET["eventid"]) : 103;
$phenomena = isset($_GET["phenomena"]) ? substr($_GET["phenomena"],0,2) : "SV";
$significance = isset($_GET["significance"]) ? substr($_GET["significance"],0,1) : "W";
$warngeo = isset($_GET["warngeo"]) ? $_GET["warngeo"] : "both";

if ($phenomena != "SV" && $phenomena != "TO" && $phenomena != "MA" && $phenomena != "FF") 
{ 
  $warngeo = "county";
}
if (($phenomena == "SV" || $phenomena == "TO" || $phenomena == "MA" || $phenomena == "FF") 
     && !isset($_GET["warngeo"]))
{
   $warngeo = "sbw";
}
/* Only give option for polygon on warnings */
if ($significance != "W")
{ 
  $warngeo = "both";
}



/* We need to fetch the extent */
$query1 = "SELECT xmax(extent(geom)) as x1, xmin(extent(geom)) as x0, 
                  ymin(extent(geom)) as y0, ymax(extent(geom)) as y1 
                  from warnings_$year WHERE wfo = '$wfo' and 
                  phenomena = '$phenomena' and eventid = $eventid 
                  and significance = '$significance'";
$result = pg_exec($connect, $query1);
$row = pg_fetch_array($result, 0);
$lpad = 0.5;
$y1 = $row["y1"] +$lpad; $y0 = $row["y0"]-$lpad; 
$x1 = $row["x1"] +$lpad; $x0 = $row["x0"]-$lpad;
$xc = $x0 + ($row["x1"] - $row["x0"]) / 2;
$yc = $y0 + ($row["y1"] - $row["y0"]) / 2;

/* Now we fetch warning and perhaps polygon */
$query2 = "SELECT *, astext(geom) as t, askml(geom) as kml,
           length(CASE WHEN svs IS NULL THEN '' ELSE svs END) as sz 
           from warnings_$year 
           WHERE wfo = '$wfo' and phenomena = '$phenomena' and 
           eventid = $eventid and significance = '$significance'";
if ($significance == "W" && 
   ($phenomena == "SV" or $phenomena == "TO" or $phenomena == "MA" or $phenomena == "FF"))
{
  $query2 .= " and gtype = 'P'";
}
$result = pg_exec($connect, $query2 ." ORDER by sz DESC, updated DESC, gtype ASC");



/* BEGIN HTML output */
$HEADEXTRA = "<script type=\"text/javascript\" src=\"${rooturl}/ext/adapter/ext/ext-base.js\"></script>
<script type=\"text/javascript\" src=\"${rooturl}/ext/ext-all.js\"></script>
<script type=\"text/javascript\" src=\"${rooturl}/ext/ux/menu/EditableItem.js\"></script>
<script type=\"text/javascript\" src=\"${rooturl}/ext/ux/grid/GridFilters.js\"></script>
<script type=\"text/javascript\" src=\"${rooturl}/ext/ux/grid/filter/Filter.js\"></script>
<script type=\"text/javascript\" src=\"${rooturl}/ext/ux/grid/filter/StringFilter.js\"></script>
<script type=\"text/javascript\" src=\"RowExpander.js\"></script>
<link rel=\"stylesheet\" type=\"text/css\" href=\"${rooturl}/ext/resources/css/ext-all.css\" />
<script type=\"text/javascript\" src=\"warnings_cat_lib.js\"></script>
";
if ($warngeo == "sbw")
{
 $HEADEXTRA .= "<script src=\"http://maps.google.com/maps?file=api&amp;v=2&amp;key=". $GOOGLEKEYS[$rooturl]["rview"] ."\" type=\"text/javascript\"></script>";
}
$THISPAGE = "severe-vtec";
$TITLE = "IEM | VTEC Product Browser";
include("$rootpath/include/header.php");

if (pg_numrows($result) > 0) {
  $row = pg_fetch_array($result, 0);
} else{
  $row = Array("issue" => time(), "expire" => time() , "report" => "", 
               "svs" => "", "status" => "NEW");
}

/* Determine time base, 4 minutes from product issuance */
$issue = strtotime(substr($row["issue"],0,16)) + 240;
$cow_issue = strtotime(substr($row["issue"],0,16)) - 21600;
$cow_expire = strtotime(substr($row["issue"],0,16)) + 21600;

$lsrwindow = 0;
if ($significance == "W" && ($phenomena == "SV" or $phenomena == "TO" or $phenomena == "MA")) 
{
  $hard_code_lsr_time = 1;
  $lsr_sts = strtotime(substr($row["issue"],0,16));
  $lsr_ets = strtotime(substr($row["expire"],0,16));
  $lsrwindow = 1;
}

$cow_url = sprintf("%s/cow/?syear=%s&smonth=%s&sday=%s&shour=%s&eyear=%s&emonth=%s&eday=%s&ehour=%s&wfo=%s&wtype[]=TO&wtype[]=SV&hail=0.75&ltype[]=TO&ltype[]=SV", $rooturl, date("Y", $cow_issue), date("m", $cow_issue),date("d", $cow_issue),date("H", $cow_issue), date("Y", $cow_expire), date("m", $cow_expire), date("d", $cow_expire), date("H", $cow_expire), $wfo);
$gis_url = sprintf("http://mesonet.agron.iastate.edu/cgi-bin/request/gis/watchwarn.py?year=%s&month1=%s&day1=%s&hour1=%s&minute1=0&month2=%s&day2=%s&hour2=%s&minute2=0",  date("Y", $cow_issue), date("m", $cow_issue),date("d", $cow_issue),date("H", $cow_issue), date("m", $cow_expire), date("d", $cow_expire), date("H", $cow_expire) );
$radar_url = sprintf("%s/GIS/apps/rview/warnings.phtml?archive=yes&tz=UTC&cu=0&year=%s&month=%s&day=%s&hour=%s&minute=%s&tzoff=0&sortdir=DESC&loop=0&sortcol=issue&c=yes&lon0=%s&lat0=%s", $rooturl, date("Y", $issue), date("m", $issue), date("d", $issue), date("H", $issue), date("i", $issue), ($x1+$x0)/2.0, ($y1 + $y0) / 2.0);

$cow = "";
if ($significance == "W") 
{
  $cow = "<br /><a href=\"$cow_url\">Polygon Verification</a>";
}


$next_eventid = $eventid + 1;
$last_eventid = $eventid - 1;
$next_link = sprintf("<a href=\"%s/GIS/apps/rview/warnings_cat.phtml?year=%s&wfo=%s&phenomena=%s&eventid=%s&significance=%s&warngeo=%s\">Next</a> ", $rooturl, $year, $wfo, $phenomena, $next_eventid, $significance, $warngeo);
$kml_link = sprintf("http://mesonet.agron.iastate.edu/kml/sbw_exact_time.php?year=%s&wfo=%s&phenomena=%s&eventid=%s&significance=%s&warngeo=%s", $year, $wfo, $phenomena, $eventid, $significance, $warngeo);

$last_link = "";
if ($last_eventid > 0)
  $last_link = sprintf(" <a href=\"%s/GIS/apps/rview/warnings_cat.phtml?year=%s&wfo=%s&phenomena=%s&eventid=%s&significance=%s&warngeo=%s\">Previous</a> ", $rooturl, $year, $wfo, $phenomena, $last_eventid, $significance, $warngeo);
  


$radarTS = $issue;
$radarLabel = "At product issuance";
$wmslayer = "nexrad-n0r-wmst";
$ts2 = determine_time_base($radarTS);
$wms_time_extra = "lURL+=\"&TIME=". strftime("%Y-%m-%dT%H:%M:00Z",$ts2) ."\";\n";
if (time() < strtotime(substr($row["expire"],0,16)))
{
  $wmslayer = "nexrad-n0r";
  $wms_time_extra = "";
  $radarTS = strtotime(substr($row["expire"],0,16));
  $radarLabel = "Current";
}

if (pg_numrows($result) > 0) {
  $ts = determine_time_base($radarTS);
  $basets = $ts;
  $isarchive = 1;
  if (time() < ($ts + 450)) $isarchive = 0;
  $imgi = 0;
  $tzoff = 0;
  $interval = 5;
  $width = 640;
  $height = 480;
  $lsrlook = 0;
  $layers = array("uscounties_and_name", "warnings", "nexrad");
  $maptitle = "IEM NEXRAD valid:";
  $singleWarning = 1;
  dl($mapscript);
  //include("warnings_plot.php");
}

if ($warngeo == "sbw") {
  $url = sprintf("%s/GIS/radmap.php?layers[]=sbw&vtec=%s.K%s.%s.%s.%04d", $rooturl, $year, $wfo, $phenomena, $significance, $eventid);
}
else if ($warngeo == "both") {
  $url = sprintf("%s/GIS/radmap.php?layers[]=cbw&layers[]=sbw&vtec=%s.K%s.%s.%s.%04d", $rooturl, $year, $wfo, $phenomena, $significance, $eventid);
} else {
  $url = sprintf("%s/GIS/radmap.php?layers[]=cbw&vtec=%s.K%s.%s.%s.%04d", $rooturl, $year, 
       $wfo, $phenomena, $significance, $eventid);
}


echo "
<style type=\"text/css\">
td.x-grid3-td-locations {
    overflow: hidden;
}
td.x-grid3-td-locations div.x-grid3-cell-inner {
    white-space: normal;
}
</style>
<div id='controller' style='padding: 5px;'>
<form method=\"GET\" name=\"changero\">
<table>
<tr><td>NWS WFO:</td><td>". wfoSelect($wfo) ."</td></tr>
<tr><td>Year:</td><td>". yearSelect(2005,$year) ."</td></tr>
<tr><td>Event ID:</td><td>$last_link <input name=\"eventid\" type=\"text\" size=\"5\" value=\"". $eventid ."\"> $next_link</td></tr>
<tr><td>Phenomena:</td><td>". vtecPhenoSelect($phenomena) ."</td></tr>
<tr><td>Significance:</td><td>". vtecSigSelect($significance) ."</td></tr>
<tr><td>Status:</td><td>". $vtec_status[ $row["status"] ] ."</td></tr>
<tr><td>Issued:</td><td>". substr($row["issue"],0,16) ." GMT</td></tr>
<tr><td>Expires:</td><td>". substr($row["expire"],0,16) ." GMT</td></tr>"; ?>

<tr><td>Warning<br />geography:</td>
<td><select name="warngeo">
 <option value="both" <?php if ($warngeo == "both") echo "SELECTED"; ?>>County + Polygon</option>
 <option value="county" <?php if ($warngeo == "county") echo "SELECTED"; ?>>County Only</option>
 <option value="sbw" <?php if ($warngeo == "sbw") echo "SELECTED"; ?>>Storm based warning</option>
</select></td></tr>

</table>

<p><br /><input type="submit" value="Load Product">

<p><br /><br /><strong>Links:</strong>
 <?php echo $cow; ?>
 <br /><a href="<?php echo $gis_url; ?>">Download Shapefile of Warnings</a>
 <br /><a href="<?php echo $radar_url; ?>">Interactive RADAR Display</a>
<br />

</form>
</div>

<h3 class="heading">Valid Time Extent Code (VTEC) Product Browser</h3>
<table border="0">
<tr><td valign="top">

<div id="displaytabs">
<div id="radar" class="x-hide-display">
<h2 class="page-title"><?php echo $radarLabel; ?> NWS NEXRAD Composite + Warning</h2>
<p><img src="<?php echo $url; ?>"></p>
</div>
<div id="gmapper" class="x-hide-display">
</div>
</div>

</td><td valign="top">

<div id='controller-side'></div>

<?php
echo "</td></tr></table>
<p>&nbsp;<br />

<div id=\"tabs1\" style=\"height: 600px;\">
<div class=\"x-tab\" title=\"Issuance\"><pre>". htmlspecialchars( str_replace("\001", "", $row["report"]) ) ."</pre></div>\n";


$lsvs = htmlspecialchars( str_replace("\001", "", $row["report"]) );
$q = 1;
if (strlen($row["svs"]) > 0 ) 
{
  $parts = explode('__', $row["svs"]);
  for ($i=1;$i<(sizeof($parts) - 1);$i++)
  {
     $svs = htmlspecialchars( str_replace("\001", "", $parts[$i]) );
     if ($svs == $lsvs) continue;
     $lsvs = $svs;
     echo "<div class=\"x-tab\" title=\"Update $q\"><pre>${svs}</pre></div>\n";
     $q += 1;
  }
}
$v = $q - 1;
$json_params = sprintf("year=%s&wfo=%s&phenomena=%s&eventid=%s&significance=%s", $year, $wfo, $phenomena, $eventid, $significance);
echo "</div>
<script>
//<!-- 
var gxml;
var map;

Ext.onReady(function(){

  Ext.getCmp('text-display').activate($v);

  Ext.getCmp('lsr-grid').on('activate', function(q){
      if (! this.getStore().isLoaded){
        this.getStore().load({
         params:'${json_params}&sbw=1'
        });
        this.getStore().isLoaded=true;
      }
  });

  Ext.getCmp('products-grid').on('activate', function(q){
      if (! this.getStore().isLoaded){
        this.getStore().load({
         params:'${json_params}'
        });
        this.getStore().isLoaded=true;
      }
  });

  Ext.getCmp('all-lsr-grid').on('activate', function(q){
      if (! this.getStore().isLoaded){
        this.getStore().load({
         params:'${json_params}'
        });
        this.getStore().isLoaded=true;
      }
  });

  Ext.getCmp('ugc-grid').on('activate', function(q){
      if (! this.getStore().isLoaded){
        this.getStore().load({
         params:'${json_params}'
        });
        this.getStore().isLoaded=true;
      }
  });
";
if ($significance != "W" ||
   ($phenomena != "SV" && $phenomena != "TO" && $phenomena != "MA"))
{
  echo "Ext.getCmp('lsr-grid').disable();\n";
}
if (pg_numrows($result) == 0) {
  echo "
 Ext.getCmp('radar-display').disable();
 Ext.getCmp('lsr-grid').disable();
 Ext.getCmp('all-lsr-grid').disable();
 Ext.getCmp('ugc-grid').disable();
 Ext.getCmp('top-display').setActiveTab('products-grid');
 ";
  /* Figure out how to render $row["kml"] */
}
if ($warngeo == "sbw" && pg_numrows($result) > 0)
{
?>

// nexrad data
CustomGetTileUrl=function(a,b,c) {
if (typeof(window['this.myMercZoomLevel'])=="undefined") this.myMercZoomLevel=0; 
if (typeof(window['this.myStyles'])=="undefined") this.myStyles="default"; 
var lULP = new GPoint(a.x*256,(a.y+1)*256);
var lLRP = new GPoint((a.x+1)*256,a.y*256);
var lUL = G_NORMAL_MAP.getProjection().fromPixelToLatLng(lULP,b,c);
var lLR = G_NORMAL_MAP.getProjection().fromPixelToLatLng(lLRP,b,c);
// switch between Mercator and DD if merczoomlevel is set
if (this.myMercZoomLevel!=0 && map.getZoom() < this.myMercZoomLevel) {
    var lBbox=dd2MercMetersLng(lUL.lngDegrees)+","+dd2MercMetersLat(lUL.latDegrees)+","+dd2MercMetersLng(lLR.lngDegrees)+","+dd2MercMetersLat(lLR.latDegrees);
    var lSRS="EPSG:54004";
} else {
    var lBbox=lUL.x+","+lUL.y+","+lLR.x+","+lLR.y;
    var lSRS="EPSG:4326";
}
var ts = new Date();
var lURL=this.myBaseURL;
lURL+="&REQUEST=GetMap";
lURL+="&SERVICE=WMS";
lURL+="&reaspect=false&VERSION=1.1.1";
lURL+="&LAYERS="+this.myLayers;
lURL+="&STYLES="+this.myStyles; lURL+="&FORMAT="+this.myFormat;
lURL+="&BGCOLOR=0xFFFFFF";
lURL+="&TRANSPARENT=TRUE";
lURL+="&SRS="+lSRS;
<?php echo $wms_time_extra; ?>
lURL+="&BBOX="+lBbox;
lURL+="&WIDTH=256";
lURL+="&HEIGHT=256";
lURL+="&GroupName="+this.myLayers;
lURL+="&bogus="+ts.getTime();
return lURL;
}


<?php
 echo " var gtab = Ext.getCmp('top-display').insert(1, {
              id: 'gtab',
              title: 'Google Map',
              html: 'gmapper'
			}).show();
  map = new GMap2(gtab.body.dom);
  map.addControl(new GSmallMapControl());
  map.addControl(new GMapTypeControl());";
?>

<?php

  echo "var tileNEX= new GTileLayer(new GCopyrightCollection(''),1,17);
  tileNEX.myLayers='$wmslayer';
  tileNEX.myFormat='image/png';
  tileNEX.myBaseURL='http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?';
  tileNEX.getTileUrl=CustomGetTileUrl;

  var layer4=[G_NORMAL_MAP.getTileLayers()[0],tileNEX]; 
  var custommap4 = new GMapType(layer4, G_SATELLITE_MAP.getProjection(), 'Nexrad', G_SATELLITE_MAP);
  map.addMapType(custommap4);

  gxml = new GGeoXml('$kml_link');
  map.addOverlay(gxml);
  map.setCenter(new GLatLng($yc,$xc), 8); 
  map.setMapType(custommap4);
  ";

}

echo "});
-->
</script>";
echo "<form id=\"my-form-id\" action=\"d.php\" method=\"post\" target=\"_new\"></form>";
include("$rootpath/include/footer.php");
?>
