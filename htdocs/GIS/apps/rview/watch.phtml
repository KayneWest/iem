<?php
/* Plot watches since SPC's site sometimes gets slow..... */
include("../../../../config/settings.inc.php");
include("$rootpath/include/forms.php");
include("$rootpath/include/database.inc.php");
include("lib.php");
$db = iemdb("postgis");
pg_exec($db, "SET TIME ZONE 'GMT'");
$rs = pg_prepare($db, "CHECK4WATCH", "SELECT *, xmin(geom) as x0, 
      xmax(geom) as x1, ymin(geom) as y0, ymax(geom) as y1 from watches 
      where extract(year from issued) = $1 and num = $2");
putenv("TZ=GMT");

$THISPAGE = "severe-watch";
include("$rootpath/include/header.php");
$ERROR = "";

/* Needed GET variables */
$year = isset($_GET["year"]) ? intval($_GET["year"]) : date("Y");
$num = isset($_GET["num"]) ? intval($_GET["num"]) : 1;

$rs = pg_execute($db, "CHECK4WATCH", Array($year, $num));
if (pg_numrows($rs) == 0) {
  echo "<h3>Sorry, watch number $num for year $year was not found</h3>";
  include("$rootpath/include/footer.php");
  die();
}

$row = pg_fetch_array($rs,0);

$ts = strtotime($row["issued"]);
$expires = strtotime($row["expired"]);
$d = date("d F Y H:i" ,  $ts);

$maptitle = htmlentities("SPC Watch number $num during $year");
$margin = 0.5;
$url = sprintf("%s/GIS/radmap.php?title=%s&layers[]=uscounties&layers[]=nexrad&ts=%s&height=480&width=640&layers[]=watches&layers[]=watch_by_county&sector=conus&bbox=%s,%s,%s,%s", $rooturl, $maptitle, date('YmdHi', $ts), $row["x0"] -$margin, $row["y0"]-$margin, $row["x1"]+$margin, $row["y1"]+$margin);

/*____________________________ Plot LSRs */
if ($expires < time() && $year > 2002)
{
 $lurl = sprintf("%s/GIS/radmap.php?layers[]=lsrs&ts=%s&ts2=%s&height=480&width=640&layers[]=watches&sector=conus&bbox=%s,%s,%s,%s", $rooturl, date('YmdHi', $ts), date('YmdHi', $expires), $row["x0"] -$margin, $row["y0"]-$margin, $row["x1"]+$margin, $row["y1"]+$margin);
}

$ourl = sprintf("%s/GIS/radmap.php?layers[]=nexrad&ts=%s&height=240&width=320&layers[]=watches&sector=conus", $rooturl, date('YmdHi', $ts));

/*____________ web interface _________*/

?>
<a href="<?php echo $rooturl;?>/current/radar.phtml">Current Products</a> &gt; <b>SPC Watch Quick View</b>


<form method="GET" action="watch.phtml">
<table style="width: 750px;">
<tr><td><img src="<?php echo $ourl; ?>"></td>
<td valign="top">
<p><a href="watch.phtml?year=<?php echo $year; ?>&num=<?php echo $num -1; ?>">Previous Watch</a> ....  <a href="watch.phtml?year=<?php echo $year; ?>&num=<?php echo $num +1; ?>">Next Watch</a> 
<table>
<tr><th>Type:</th><td><?php echo $row["type"]; ?></td></tr>
<tr><th>Watch #:</th><td><?php echo yearSelect(1997,$year); ?><input name="num" type="text" size="5" value="<?php echo $row["num"]; ?>"> <input type="submit" value="GO!"></td></tr>
<tr><th>Issue:</th><td><?php echo substr($row["issued"],0,16); ?> GMT</td></tr>
<tr><th>Expired/Cancelled:</th><td><?php echo substr($row["expired"],0,16); ?> GMT</td></tr>
</table>
<br />* Watch archive should be complete back to 1997.
</td></tr></table>
</form>

<h3>Initial watch box and Watch By County Outline</h3>
<br /><?php echo $ERROR;?>
<img src="<?php echo $url; ?>">

<?php if (isset($lurl)){ echo "<h3>Local Storm Reports:</h3><img src=\"$lurl\">"; } ?>

<?php include("$rootpath/include/footer.php"); ?>
