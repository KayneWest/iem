<?php
include("../../../config/settings.inc.php");
define("IEM_APPID", 48);
include("$rootpath/include/wfoLocs.php");
include("$rootpath/include/forms.php");
include("$rootpath/include/database.inc.php");
include("$rootpath/include/imagemaps.php");
$afos = iemdb("afos");
$TITLE = "NWS Text Product by Issuing Center by Date";
$THISPAGE ="archive-afos";
include("$rootpath/include/header.php");

$wfo = isset($_REQUEST["wfo"])? $_REQUEST["wfo"] : null;
$source = isset($_REQUEST["source"])? substr($_GET["source"],0,4) : 'DMX';
$dbsource = $source;
if (strlen($source) == 3){ $dbsource = "K$source";}
if ($wfo != null){ $source = $wfo; }

$view = isset($_GET["view"])? $_GET["view"] : 'time';
$year = isset($_GET["year"])? intval($_GET["year"]) : date("Y");
$month = isset($_GET["month"])? intval($_GET["month"]) : date("m");
$day = isset($_GET["day"])? intval($_GET["day"]) : date("d");
$ts = mktime(0,0,0, $month, $day, $year);

$table = sprintf("products_%s_0106", $year);
if ($month > 6){
  $table = sprintf("products_%s_0712", $year);
}

pg_query($afos, "SET TIME ZONE 'GMT'");
$rs = pg_prepare($afos, "_SELECT", "SELECT pil, entered from $table
      WHERE source = $1 and entered BETWEEN $2 and $3 ORDER by entered ASC");
?>
<h3>NWS Text Products by Issuing Center by Date</h3>
<p>This application prints out a listing of IEM archived text products
by issuing NWS Issuing Center and by date.  After about
seven days, the IEM purges a lot of the frequently issued products like
SHEF and METAR data. This archive exists back to 1 January 2009.</p>

<form name="selector" method="GET">
<table>
<thead>
<tr><th>Select Issuing Center:</th>
    <th colspan="3">Select UTC Date:</th>
    <th>View Option</th>
    <th></th></tr>
</head>

<tbody>
<tr>
 <td><?php echo networkSelect(Array("WFO","RFC","NWS","NCEP"), 
 		$source, Array(), "source"); ?></td>
 <td><?php echo yearSelect(2009, $year); ?></td>
 <td><?php echo monthSelect($month); ?></td>
 <td><?php echo daySelect($day); ?></td>
 <td><select name="view">
  <option value="time" <?php if ($view == "time"){ echo "SELECTED";} ?>>Chronologically</option>
  <option value="grid" <?php if ($view == "grid"){ echo "SELECTED";} ?>>PIL Grid</option>
    </select>
 </td>
 <td><input type="submit" value="Giveme Giveme!"></td>
</table>
</form>
<?php

$rs = pg_execute($afos, "_SELECT", Array($dbsource, date("Y-m-d H:i", $ts)."+00",
      date("Y-m-d H:i", $ts+86400)."+00"));
if ($view == "grid"){
  $columns = Array();
  for($i=0;$row=@pg_fetch_array($rs,$i);$i++){
    $ts = strtotime($row["entered"]);
    $url = sprintf("p.php?pil=%s&e=%s", $row["pil"], gmdate("YmdHi", $ts));
    @$columns[$row["pil"]] .= sprintf("<br /><a href=\"%s\">%s</a> (%s)", 
       $url, $row["pil"], gmdate("H:i", $ts));
  }
  echo "<table><tr>";
  $keys = array_keys($columns);
  asort($keys);
  while(list($i,$k) = each($keys)){
    echo sprintf("<td valign=\"top\">%s</td>\n", $columns[$k]);
  }
  echo "</tr></table>";
} else {
  $l = "";
  for($i=0;$row=@pg_fetch_array($rs,$i);$i++){
    $ts = strtotime($row["entered"]);
    $url = sprintf("p.php?pil=%s&e=%s", $row["pil"], gmdate("YmdHi", $ts));
    if (gmdate("H", $ts) != $l){
      echo sprintf("<hr /><strong>%s UTC</strong>", gmdate("H", $ts));
    }
      $l = gmdate("H", $ts);
   echo sprintf("<br /><a href=\"%s\">%s</a> (%s)", $url, $row["pil"],
       gmdate("H:i", $ts));
 }
}
?>

<?php include("$rootpath/include/footer.php"); ?>
